{#
    J.A.R.V.I.S. Reusable Macros
    ============================
    Import at the top of your template:
    {% from 'partials/_macros.html' import theme_toggle, breadcrumb, online_indicator %}
#}

{# Theme Toggle Switch #}
{% macro theme_toggle() %}
<div class="theme-switch">
    <i class="bi bi-sun-fill"></i>
    <input type="checkbox" id="themeToggle" title="Toggle Dark/Light Theme">
    <i class="bi bi-moon-fill"></i>
</div>
{% endmacro %}

{# Online Users Indicator #}
{% macro online_indicator() %}
<span class="badge bg-light text-success ms-2" id="onlineUsersIndicator" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" title="Loading..." style="cursor: pointer; font-size: 0.7rem;">
    <i class="bi bi-circle-fill text-success" style="font-size: 0.4rem;"></i> <span id="onlineUsersCount">-</span> online
</span>
{% endmacro %}

{# Breadcrumb Navigation #}
{% macro breadcrumb(items, back_url=None, back_text='Back') %}
<div class="container-fluid px-4 py-2 bg-body-secondary border-bottom">
    <div class="d-flex justify-content-between align-items-center">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0 small">
                {% for item in items %}
                    {% if loop.last %}
                        <li class="breadcrumb-item active">{{ item.label }}</li>
                    {% else %}
                        <li class="breadcrumb-item"><a href="{{ item.url }}">{{ item.label }}</a></li>
                    {% endif %}
                {% endfor %}
            </ol>
        </nav>
        {% if back_url %}
        <a href="{{ back_url }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> {{ back_text }}
        </a>
        {% endif %}
    </div>
</div>
{% endmacro %}

{# Standard Page Head (CSS/Meta) #}
{% macro page_head(title) %}
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>J.A.R.V.I.S. - {{ title }}</title>
<link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/jarvis-icon.svg') }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
{% endmacro %}

{# Standard Page Scripts (Bootstrap + Theme) #}
{% macro page_scripts() %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/static/js/theme.js"></script>
{% endmacro %}

{# Online Users Tracking Script #}
{% macro online_users_script() %}
<script>
    // Online users tracking
    async function updateOnlineStatus() {
        try {
            await fetch('/api/heartbeat', { method: 'POST' });
        } catch (e) {
            console.error('Failed to update online status:', e);
        }
    }

    async function fetchOnlineUsers() {
        try {
            const resp = await fetch('/api/online-users');
            const data = await resp.json();
            const indicator = document.getElementById('onlineUsersIndicator');
            const countSpan = document.getElementById('onlineUsersCount');
            if (indicator && countSpan) {
                countSpan.textContent = data.count;
                const userList = data.users.map(u => `<span class="d-block">${u.name}</span>`).join('');
                indicator.setAttribute('data-bs-original-title', userList || 'No users online');
                // Refresh tooltip if already initialized
                const tooltip = bootstrap.Tooltip.getInstance(indicator);
                if (tooltip) tooltip.setContent({ '.tooltip-inner': userList || 'No users online' });
            }
        } catch (e) {
            console.error('Failed to get online users:', e);
        }
    }

    function initOnlineUsersTracking() {
        updateOnlineStatus();
        fetchOnlineUsers();
        setInterval(updateOnlineStatus, 60000);
        setInterval(fetchOnlineUsers, 30000);
        // Initialize tooltip
        const indicator = document.getElementById('onlineUsersIndicator');
        if (indicator) new bootstrap.Tooltip(indicator);
    }

    document.addEventListener('DOMContentLoaded', initOnlineUsersTracking);
</script>
{% endmacro %}
